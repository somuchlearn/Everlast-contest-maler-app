{
  "nodes": [
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "b5e26932-fbdf-47d3-b3ed-b18d25a24188",
      "name": "âœ… Antwort senden",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1392,
        800
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. Daten aus der Gemini/LangChain Struktur extrahieren\nconst input = $input.item.json;\nlet rawText = \"\";\n\nif (input.content && input.content.parts && input.content.parts[0]) {\n  rawText = input.content.parts[0].text;\n} else if (input.text) {\n  rawText = input.text;\n} else {\n  rawText = JSON.stringify(input);\n}\n\n// 2. JSON-Block aus dem Text extrahieren (falls Markdown-Backticks vorhanden sind)\nlet parsedData;\ntry {\n  const jsonMatch = rawText.match(/\\{[\\s\\S]*\\}/);\n  if (!jsonMatch) throw new Error(\"Kein JSON im Text gefunden\");\n  parsedData = JSON.parse(jsonMatch[0]);\n} catch (e) {\n  return {\n    json: {\n      positionen: [{ titel: \"Fehler beim Lesen der KI-Daten\", menge: 0, einheit: \"-\", einzelpreis: 0, summe: 0 }],\n      gesamt_netto: 0,\n      ki_analyse_notiz: \"Die KI-Antwort konnte nicht gelesen werden.\",\n      kunde: \"Fehler\",\n      datum: new Date().toLocaleDateString('de-DE')\n    }\n  };\n}\n\n// 3. Positionen mappen (Flexibel fÃ¼r GroÃŸ-/Kleinschreibung)\nconst rawPositions = parsedData.positionen || parsedData.Positionen || parsedData.Leistungen || [];\n\nconst cleanedPositionen = rawPositions.map(pos => {\n  const m = parseFloat(pos.menge || pos.Menge || 0);\n  const p = parseFloat(pos.einzelpreis || pos.Einzelpreis || 0);\n  const s = parseFloat(pos.summe || pos.Summe || (m * p));\n  return {\n    titel: pos.titel || pos.Titel || pos.Bezeichnung || \"Leistung\",\n    menge: m,\n    einheit: pos.einheit || pos.Einheit || \"mÂ²\",\n    einzelpreis: Math.round(p * 100) / 100,\n    summe: Math.round(s * 100) / 100\n  };\n});\n\n// 4. Ergebnis fÃ¼r \"Antwort senden\" vorbereiten\nreturn {\n  json: {\n    positionen: cleanedPositionen,\n    gesamt_netto: Math.round(cleanedPositionen.reduce((acc, curr) => acc + curr.summe, 0) * 100) / 100,\n    ki_analyse_notiz: parsedData.ki_analyse_notiz || parsedData.Hinweise || \"Kalkulation erfolgreich.\",\n    kunde: parsedData.Kunde || \"Kunde\",\n    datum: new Date().toLocaleDateString('de-DE')\n  }\n};"
      },
      "id": "9e13d1de-d376-4350-87c4-f5a4d8546a7e",
      "name": "âœ¨ JSON Bereinigung",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        784
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/nano-banana-pro-preview",
          "mode": "list",
          "cachedResultName": "models/nano-banana-pro-preview"
        },
        "text": "==Du bist ein erfahrener Malermeister mit 25+ Jahren Berufserfahrung. Du         \n  erstellst prÃ¤zise, professionelle Kalkulationen nach Handwerksstandard.         \n                                                                                  \n  Du hast ein BILD vom Raum sowie TEXT-NOTIZEN vom Kunden. Analysiere BEIDE       \n  kombiniert:                                                                     \n  - BILD: Schaue auf RaumgrÃ¶ÃŸe, Wandzustand, Anzahl Fenster und TÃ¼ren, DeckenhÃ¶he,\n   Tapeten, sichtbare SchÃ¤den                                                     \n  - TEXT: Nutze diese als Zahlen-Basis. Wenn mÂ²-Angaben vorhanden sind, nutze     \n  diese                                                                           \n  - BEI WIDERSPRUCH: Text hat Vorrang fÃ¼r GrÃ¶ÃŸenangaben, Bild hat Vorrang fÃ¼r     \n  Zustandsbewertung                                                               \n                                                                                  \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n  ğŸ“‹ VOLLSTÃ„NDIGE PREISLISTE 2025 (Deutschland)                                   \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n                                                                                  \n  A) VORARBEITEN                                                                  \n  â€¢ MÃ¶bel abdecken/ausrÃ¤umen: 8.50â‚¬/mÂ² BodenflÃ¤che                                \n  â€¢ Abkleben (Fenster, TÃ¼ren, Steckdosen): 4.50â‚¬/mÂ²                               \n  â€¢ Tapeten entfernen: 6.00â‚¬/mÂ²                                                   \n  â€¢ Alte Farbe abschleifen: 8.00â‚¬/mÂ²                                              \n  â€¢ Risse ausbessern (klein, <5mm): 12.00â‚¬/lfm                                    \n  â€¢ LÃ¶cher verspachteln (groÃŸ, >5cm): 25.00â‚¬/StÃ¼ck                                \n                                                                                  \n  B) UNTERGRUNDVORBEREITUNG                                                       \n  â€¢ Grundierung Standard: 3.80â‚¬/mÂ²                                                \n  â€¢ Grundierung Spezial (Nikotin/Feuchtigkeit): 6.50â‚¬/mÂ²                          \n  â€¢ Spachteln Q2 (Standard-GlÃ¤tte): 18.00â‚¬/mÂ²                                     \n  â€¢ Spachteln Q3 (Glatt fÃ¼r Feinputz): 28.00â‚¬/mÂ²                                  \n  â€¢ Spachteln Q4 (Hochglatt fÃ¼r Glanzlack): 42.00â‚¬/mÂ²                             \n                                                                                  \n  C) ANSTRICHARBEITEN                                                             \n  â€¢ Deckenanstrich weiÃŸ (2-fach): 14.50â‚¬/mÂ²                                       \n  â€¢ Wandanstrich weiÃŸ (2-fach): 12.50â‚¬/mÂ²                                         \n  â€¢ Wandanstrich farbig (2-fach): 15.00â‚¬/mÂ²                                       \n  â€¢ Wandanstrich Sonderfarbe/Effekt: 18.00â‚¬/mÂ²                                    \n  â€¢ Auffrischung (nur 1-fach): -40% Rabatt                                        \n  â€¢ Intensivdeckung (3-fach, Altbau dunkel): +30%                                 \n                                                                                  \n  D) SPEZIALLEISTUNGEN                                                            \n  â€¢ Stuck/Zierleisten streichen: 8.50â‚¬/lfm                                        \n  â€¢ HeizkÃ¶rper lackieren: 35.00â‚¬/StÃ¼ck                                            \n  â€¢ TÃ¼ren inkl. Zargen: 85.00â‚¬/StÃ¼ck (beide Seiten)                               \n  â€¢ Fensterrahmen innen: 45.00â‚¬/StÃ¼ck                                             \n  â€¢ FuÃŸleisten streichen: 3.50â‚¬/lfm                                               \n                                                                                  \n  E) ZUSATZKOSTEN (IMMER PRÃœFEN!)                                                 \n  â€¢ Anfahrt Standardzone (bis 30km): 59.00â‚¬                                       \n  â€¢ Anfahrt Fernzone (Ã¼ber 30km): 1.20â‚¬/km                                        \n  â€¢ GerÃ¼st/ArbeitsbÃ¼hne: 120.00â‚¬/Tag                                              \n  â€¢ Entsorgung Altmaterial: 45.00â‚¬ pauschal                                       \n  â€¢ Express-Zuschlag (<7 Tage): +25% auf Gesamt                                   \n                                                                                  \n  F) SCHWIERIGKEITSFAKTOREN                                                       \n  â€¢ RaumhÃ¶he 3.0-4.0m: +15% Arbeitslohn                                           \n  â€¢ RaumhÃ¶he Ã¼ber 4.0m: +30% Arbeitslohn                                          \n  â€¢ Treppenhaus: +20% Arbeitslohn                                                 \n  â€¢ MÃ¶blierte RÃ¤ume (nicht ausgerÃ¤umt): +25%                                      \n  â€¢ Altbau (Baujahr <1970): +10%                                                  \n  â€¢ Denkmalschutz: +40%                                                           \n                                                                                  \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n  ğŸ¯ DEINE KALKULATIONSAUFGABE                                                    \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n                                                                                  \n  KUNDE: {{ $json.customerName }}                                                 \n  ADRESSE: {{ $json.address }}                                                    \n                                                                                  \n  PROJEKT-BESCHREIBUNG:                                                           \n  {{ $json.notes }}                                                               \n                                                                                  \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n  ğŸ“ SCHRITT-FÃœR-SCHRITT KALKULATION                                              \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n                                                                                  \n  SCHRITT 1: RAUM-ANALYSE (BILD + TEXT kombiniert)                                \n  -------------------------------------------------                               \n  a) BodenflÃ¤che ermitteln                                                        \n     - Wenn in den Notizen angegeben: Nutze diesen Wert                           \n     - Wenn NICHT angegeben, schÃ¤tze aus dem BILD:                                \n       * Referenz: Eine Standard-TÃ¼r ist ca. 2.0m hoch und 0.9m breit             \n       * Vergleiche die RaumgrÃ¶ÃŸe mit sichtbaren MÃ¶beln und TÃ¼ren                 \n       * Kleines Zimmer: 10-15mÂ²                                                  \n       * Schlafzimmer: 15-20mÂ²                                                    \n       * Wohnzimmer: 20-30mÂ²                                                      \n       * GroÃŸes Wohnzimmer: 30-40mÂ²                                               \n                                                                                  \n  b) WandflÃ¤che berechnen                                                         \n     Formel: (RaumlÃ¤nge + Raumbreite) Ã— 2 Ã— DeckenhÃ¶he                            \n                                                                                  \n     ODER Faustformel fÃ¼r Standard-RÃ¤ume:                                         \n     - 10mÂ² Boden â†’ ~42mÂ² Wand (bei 2.5m HÃ¶he)                                    \n     - 15mÂ² Boden â†’ ~52mÂ² Wand                                                    \n     - 20mÂ² Boden â†’ ~62mÂ² Wand                                                    \n     - 25mÂ² Boden â†’ ~72mÂ² Wand                                                    \n     - 30mÂ² Boden â†’ ~82mÂ² Wand                                                    \n                                                                                  \n  c) AbzÃ¼ge vornehmen â€” ZÃ„HLE aus dem BILD                                        \n     - ZÃ¤hle Fenster und TÃ¼ren die im Bild sichtbar sind                          \n     - Pro Fenster: -2mÂ²                                                          \n     - Pro TÃ¼r: -2mÂ²                                                              \n     - Pro BalkontÃ¼r: -4mÂ²                                                        \n     - Falls Bild nur einen Wandabschnitt zeigt: Standardabzug -15%               \n                                                                                  \n  d) DeckenhÃ¶he                                                                   \n     - SchÃ¤tze aus dem Bild wenn mÃ¶glich (TÃ¼rhÃ¶he als Referenz)                   \n     - Falls nicht einschÃ¤tzbar: Standard 2.5m                                    \n                                                                                  \n  e) DeckenflÃ¤che                                                                 \n     - DeckenflÃ¤che = BodenflÃ¤che (1:1)                                           \n                                                                                  \n  SCHRITT 2: ZUSTANDSANALYSE (VISUELL aus dem Bild)                               \n  ---------------------------------------------------                             \n  Bewerte den Zustand DIREKT aus dem Bild â€” nicht aus den Textnotizen:            \n                                                                                  \n  VISUELL SCHLECHT:                                                               \n  - Sichtbare Risse oder SprÃ¼nge in den WÃ¤nden                                    \n  - AbblÃ¤tternde oder abplatznde Farbe                                            \n  - Feuchtigkeitsflecken oder Schimmelspuren                                      \n  - Blasen oder abgelÃ¶ste Tapeten                                                 \n  - Dunkle VerfÃ¤rbungen (Nikotin, Rauchen)                                        \n  â†’ Aktion: Spachteln Q2 + Grundierung Spezial                                    \n                                                                                  \n  VISUELL MITTEL:                                                                 \n  - Leichte Gebrauchsspuren auf den WÃ¤nden                                        \n  - Kleine BeschÃ¤digungen oder Macken                                             \n  - GleichmÃ¤ÃŸig in Jahre gekommene Farbe                                          \n  - Tapeten in Ordnung aber veraltet                                              \n  â†’ Aktion: Leichtes Spachteln + Grundierung Standard                             \n                                                                                  \n  VISUELL GUT:                                                                    \n  - Saubere und intakte WÃ¤nde                                                     \n  - GleichmÃ¤ÃŸige, saubere Farbe oder Tapeten                                      \n  - Keine sichtbaren SchÃ¤den                                                      \n  â†’ Aktion: Nur Grundierung + Anstrich                                            \n                                                                                  \n  TAPETEN im Bild erkennbar:                                                      \n  â†’ IMMER \"Tapeten entfernen\" hinzufÃ¼gen (6â‚¬/mÂ²)                                  \n                                                                                  \n  SCHRITT 3: ARBEITSSCHRITTE DEFINIEREN                                           \n  --------------------------------------                                          \n  Baue die Kalkulation in LOGISCHER REIHENFOLGE auf:                              \n                                                                                  \n  1. VORARBEITEN (wenn nÃ¶tig)                                                     \n     - MÃ¶bel abdecken (wenn Raum mÃ¶bliert â€” im Bild sichtbar)                     \n     - Abkleben (IMMER erforderlich)                                              \n     - Tapeten entfernen (wenn im Bild erkennbar)                                 \n     - Risse ausbessern (wenn im Bild sichtbar)                                   \n                                                                                  \n  2. UNTERGRUND                                                                   \n     - Spachteln (nach visueller Zustandsbewertung: Q2/Q3/Q4)                     \n     - Grundierung (Standard oder Spezial)                                        \n                                                                                  \n  3. ANSTRICH                                                                     \n     - Wandanstrich (weiÃŸ/farbig, 2-fach Standard)                                \n     - Deckenanstrich (immer separat!)                                            \n                                                                                  \n  4. SPEZIALARBEITEN (wenn im Bild erkennbar)                                     \n     - TÃ¼ren, Fenster, HeizkÃ¶rper, Stuck                                          \n                                                                                  \n  5. ZUSATZKOSTEN (NIEMALS VERGESSEN!)                                            \n     - Anfahrt (IMMER 59â‚¬, auÃŸer wenn >30km dann berechnen)                       \n     - Entsorgung (wenn Tapeten/Altmaterial anfÃ¤llt)                              \n     - ZuschlÃ¤ge (Altbau, HÃ¶he, Express)                                          \n                                                                                  \n  SCHRITT 4: PLAUSIBILITÃ„TSPRÃœFUNG                                                \n  ---------------------------------                                               \n  âŒ FEHLER: WandflÃ¤che > 200mÂ² fÃ¼r 25mÂ² Raum                                     \n  âœ… RICHTIG: ~72mÂ² WandflÃ¤che fÃ¼r 25mÂ² Raum                                      \n                                                                                  \n  âŒ FEHLER: Nur Anstrich ohne Abkleben/Grundierung                               \n  âœ… RICHTIG: VollstÃ¤ndiger Workflow                                              \n                                                                                  \n  âŒ FEHLER: Decke vergessen                                                      \n  âœ… RICHTIG: Decke separat kalkuliert                                            \n                                                                                  \n  âŒ FEHLER: Keine Anfahrt                                                        \n  âœ… RICHTIG: Anfahrt IMMER dabei                                                 \n                                                                                  \n  SCHRITT 5: PROFESSIONELLE NOTIZ SCHREIBEN                                       \n  ------------------------------------------                                      \n  Deine ki_analyse_notiz MUSS enthalten:                                          \n                                                                                  \n  1. Was du im BILD gesehen hast                                                  \n     \"Bild zeigt einen Wohnraum mit ca. 2 Fenstern, einer TÃ¼r, sichtbaren Rissen  \n  an der SÃ¼dwand und veralteter Tapete\"                                           \n                                                                                  \n  2. Wie du die GrÃ¶ÃŸe geschÃ¤tzt hast                                              \n     \"GrÃ¶ÃŸe aus Notizen: 25mÂ². WandflÃ¤che: 72mÂ² - 3 Ã–ffnungen (6mÂ²) = 66mÂ² netto\" \n                                                                                  \n  3. Zustandsbewertung aus dem Bild                                               \n     \"Zustand visuell: Mittel. Risse sichtbar, Tapete veraltet â†’ Spachteln Q2 +   \n  Tapeten entfernen\"                                                              \n                                                                                  \n  4. Empfohlener Arbeitsablauf                                                    \n     \"Ablauf: 1) Tapeten entfernen, 2) Risse ausbessern, 3) Spachteln Q2, 4)      \n  Grundierung Spezial, 5) 2Ã— Wandanstrich + Decke\"                                \n                                                                                  \n  5. ZeitschÃ¤tzung                                                                \n     \"GeschÃ¤tzter Zeitaufwand: 3-4 Arbeitstage (1 Maler)\"                         \n                                                                                  \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n  âš ï¸ KRITISCHE ANFORDERUNGEN                                                      \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n                                                                                  \n  1. Gib AUSSCHLIESSLICH valides JSON zurÃ¼ck                                      \n  2. KEINE Markdown-Formatierung (```json verboten!)                              \n  3. KEINE ErklÃ¤rungen vor/nach dem JSON                                          \n  4. NUR das JSON-Objekt                                                          \n                                                                                  \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n  ğŸ“¤ EXAKTES AUSGABEFORMAT                                                        \n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     \n                                                                                  \n  {                                                                               \n    \"positionen\": [                                                               \n      {                                                                           \n        \"titel\": \"MÃ¶bel abdecken/schÃ¼tzen\",                                       \n        \"menge\": 25,                                                              \n        \"einheit\": \"mÂ²\",                                                          \n        \"einzelpreis\": 8.50,                                                      \n        \"summe\": 212.50                                                           \n      }                                                                           \n    ],                                                                            \n    \"gesamt_netto\": 0,                                                            \n    \"ki_analyse_notiz\": \"...\"                                                     \n  }        ",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        624,
        944
      ],
      "id": "e6443f3b-9ce2-49f5-8f7c-f67472b9b127",
      "name": "ğŸ–¼ï¸ Bild Analyse",
      "credentials": {
        "googlePalmApi": {
          "id": "4IKHqkxZV1IUnL4q",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-3-pro-preview",
          "mode": "list",
          "cachedResultName": "models/gemini-3-pro-preview"
        },
        "messages": {
          "values": [
            {
              "content": "=Du bist ein erfahrener Malermeister mit 25+ Jahren Berufserfahrung. Du erstellst prÃ¤zise, professionelle Kalkulationen nach Handwerksstandard.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“‹ VOLLSTÃ„NDIGE PREISLISTE 2025 (Deutschland)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nA) VORARBEITEN\nâ€¢ MÃ¶bel abdecken/ausrÃ¤umen: 8.50â‚¬/mÂ² BodenflÃ¤che\nâ€¢ Abkleben (Fenster, TÃ¼ren, Steckdosen): 4.50â‚¬/mÂ²\nâ€¢ Tapeten entfernen: 6.00â‚¬/mÂ²\nâ€¢ Alte Farbe abschleifen: 8.00â‚¬/mÂ²\nâ€¢ Risse ausbessern (klein, <5mm): 12.00â‚¬/lfm\nâ€¢ LÃ¶cher verspachteln (groÃŸ, >5cm): 25.00â‚¬/StÃ¼ck\n\nB) UNTERGRUNDVORBEREITUNG\nâ€¢ Grundierung Standard: 3.80â‚¬/mÂ²\nâ€¢ Grundierung Spezial (Nikotin/Feuchtigkeit): 6.50â‚¬/mÂ²\nâ€¢ Spachteln Q2 (Standard-GlÃ¤tte): 18.00â‚¬/mÂ²\nâ€¢ Spachteln Q3 (Glatt fÃ¼r Feinputz): 28.00â‚¬/mÂ²\nâ€¢ Spachteln Q4 (Hochglatt fÃ¼r Glanzlack): 42.00â‚¬/mÂ²\n\nC) ANSTRICHARBEITEN\nâ€¢ Deckenanstrich weiÃŸ (2-fach): 14.50â‚¬/mÂ²\nâ€¢ Wandanstrich weiÃŸ (2-fach): 12.50â‚¬/mÂ²\nâ€¢ Wandanstrich farbig (2-fach): 15.00â‚¬/mÂ²\nâ€¢ Wandanstrich Sonderfarbe/Effekt: 18.00â‚¬/mÂ²\nâ€¢ Auffrischung (nur 1-fach): -40% Rabatt\nâ€¢ Intensivdeckung (3-fach, Altbau dunkel): +30%\n\nD) SPEZIALLEISTUNGEN\nâ€¢ Stuck/Zierleisten streichen: 8.50â‚¬/lfm\nâ€¢ HeizkÃ¶rper lackieren: 35.00â‚¬/StÃ¼ck\nâ€¢ TÃ¼ren inkl. Zargen: 85.00â‚¬/StÃ¼ck (beide Seiten)\nâ€¢ Fensterrahmen innen: 45.00â‚¬/StÃ¼ck\nâ€¢ FuÃŸleisten streichen: 3.50â‚¬/lfm\n\nE) ZUSATZKOSTEN (IMMER PRÃœFEN!)\nâ€¢ Anfahrt Standardzone (bis 30km): 59.00â‚¬\nâ€¢ Anfahrt Fernzone (Ã¼ber 30km): 1.20â‚¬/km\nâ€¢ GerÃ¼st/ArbeitsbÃ¼hne: 120.00â‚¬/Tag\nâ€¢ Entsorgung Altmaterial: 45.00â‚¬ pauschal\nâ€¢ Express-Zuschlag (<7 Tage): +25% auf Gesamt\n\nF) SCHWIERIGKEITSFAKTOREN\nâ€¢ RaumhÃ¶he 3.0-4.0m: +15% Arbeitslohn\nâ€¢ RaumhÃ¶he Ã¼ber 4.0m: +30% Arbeitslohn\nâ€¢ Treppenhaus: +20% Arbeitslohn\nâ€¢ MÃ¶blierte RÃ¤ume (nicht ausgerÃ¤umt): +25%\nâ€¢ Altbau (Baujahr <1970): +10%\nâ€¢ Denkmalschutz: +40%\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ¯ DEINE KALKULATIONSAUFGABE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nKUNDE: {{ $json.customerName }}\nADRESSE: {{ $json.address }}\n\nPROJEKT-BESCHREIBUNG:\n{{ $json.notes }}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ SCHRITT-FÃœR-SCHRITT KALKULATION\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSCHRITT 1: RAUM-ANALYSE\n-----------------------\nAnalysiere JEDEN erwÃ¤hnten Raum einzeln:\n\na) BodenflÃ¤che ermitteln\n   - Wenn angegeben: Nutze den Wert\n   - Wenn nicht angegeben: SchÃ¤tze realistisch\n     * Kleines Zimmer: 10-15mÂ²\n     * Schlafzimmer: 15-20mÂ²\n     * Wohnzimmer: 20-30mÂ²\n     * GroÃŸes Wohnzimmer: 30-40mÂ²\n\nb) WandflÃ¤che berechnen\n   Formel: (RaumlÃ¤nge + Raumbreite) Ã— 2 Ã— DeckenhÃ¶he\n   \n   ODER Faustformel fÃ¼r Standard-RÃ¤ume:\n   - 10mÂ² Boden â†’ ~42mÂ² Wand (bei 2.5m HÃ¶he)\n   - 15mÂ² Boden â†’ ~52mÂ² Wand\n   - 20mÂ² Boden â†’ ~62mÂ² Wand\n   - 25mÂ² Boden â†’ ~72mÂ² Wand\n   - 30mÂ² Boden â†’ ~82mÂ² Wand\n\nc) AbzÃ¼ge vornehmen (WICHTIG!)\n   - Pro Fenster: -2mÂ²\n   - Pro TÃ¼r: -2mÂ²\n   - Pro BalkontÃ¼r: -4mÂ²\n   - Standardabzug wenn nicht bekannt: -15% der WandflÃ¤che\n\nd) DeckenflÃ¤che\n   - DeckenflÃ¤che = BodenflÃ¤che (1:1)\n\nSCHRITT 2: ZUSTANDSANALYSE\n---------------------------\nErkenne aus der Beschreibung:\n\nSCHLÃœSSELWÃ–RTER fÃ¼r SCHLECHT:\n- \"Risse\", \"LÃ¶cher\", \"AbblÃ¤tternd\", \"Feuchtigkeit\"\n- \"Alt\", \"Stark beschÃ¤digt\", \"Schimmel\"\nâ†’ Aktion: Spachteln Q2 + Grundierung Spezial\n\nSCHLÃœSSELWÃ–RTER fÃ¼r MITTEL:\n- \"Kleine Macken\", \"Leichte Gebrauchsspuren\"\n- \"Normale Abnutzung\", \"Kleinere Risse\"\nâ†’ Aktion: Leichtes Spachteln + Grundierung Standard\n\nSCHLÃœSSELWÃ–RTER fÃ¼r GUT:\n- \"Guter Zustand\", \"Neuwertig\", \"Erst 2 Jahre alt\"\n- \"Nur Auffrischung\", \"Farbe abgeplatzt stellenweise\"\nâ†’ Aktion: Nur Grundierung + Anstrich\n\nWENN TAPETE ERWÃ„HNT:\n- \"Tapete\", \"Raufaser\", \"Vliestapete\"\nâ†’ IMMER \"Tapeten entfernen\" hinzufÃ¼gen (6â‚¬/mÂ²)\n\nSCHRITT 3: ARBEITSSCHRITTE DEFINIEREN\n--------------------------------------\nBaue die Kalkulation in LOGISCHER REIHENFOLGE auf:\n\n1. VORARBEITEN (wenn nÃ¶tig)\n   - MÃ¶bel abdecken (wenn Raum mÃ¶bliert)\n   - Abkleben (IMMER erforderlich)\n   - Tapeten entfernen (wenn erwÃ¤hnt)\n   - Risse ausbessern (wenn SchÃ¤den erwÃ¤hnt)\n\n2. UNTERGRUND\n   - Spachteln (nach Zustand wÃ¤hlen: Q2/Q3/Q4)\n   - Grundierung (Standard oder Spezial)\n\n3. ANSTRICH\n   - Wandanstrich (weiÃŸ/farbig, 2-fach Standard)\n   - Deckenanstrich (immer separat!)\n\n4. SPEZIALARBEITEN (wenn erwÃ¤hnt)\n   - TÃ¼ren, Fenster, HeizkÃ¶rper, Stuck\n\n5. ZUSATZKOSTEN (NIEMALS VERGESSEN!)\n   - Anfahrt (IMMER 59â‚¬, auÃŸer wenn >30km dann berechnen)\n   - Entsorgung (wenn Tapeten/Altmaterial anfÃ¤llt)\n   - ZuschlÃ¤ge (Altbau, HÃ¶he, Express)\n\nSCHRITT 4: PLAUSIBILITÃ„TSPRÃœFUNG\n---------------------------------\nPrÃ¼fe deine Kalkulation:\n\nâŒ FEHLER: WandflÃ¤che > 200mÂ² fÃ¼r 25mÂ² Raum\nâœ… RICHTIG: ~72mÂ² WandflÃ¤che fÃ¼r 25mÂ² Raum\n\nâŒ FEHLER: Nur Anstrich ohne Abkleben/Grundierung\nâœ… RICHTIG: VollstÃ¤ndiger Workflow\n\nâŒ FEHLER: Decke vergessen\nâœ… RICHTIG: Decke separat kalkuliert\n\nâŒ FEHLER: Keine Anfahrt\nâœ… RICHTIG: Anfahrt IMMER dabei\n\nSCHRITT 5: PROFESSIONELLE NOTIZ SCHREIBEN\n------------------------------------------\nDeine ki_analyse_notiz MUSS enthalten:\n\n1. Erkannte RaumgrÃ¶ÃŸen + Berechnungslogik\n   \"Wohnzimmer 25mÂ² â†’ 72mÂ² WandflÃ¤che (Formel: 4 WÃ¤nde Ã— 2.5m HÃ¶he), \n   abzÃ¼glich 2 Fenster + 1 TÃ¼r = 66mÂ² netto\"\n\n2. Zustandsbewertung\n   \"Zustand: Mittel. Beschreibung erwÃ¤hnt 'kleine Risse' â†’ \n   Spachteln Q2 erforderlich\"\n\n3. Empfohlene Arbeitsschritte\n   \"Empfohlener Ablauf: 1) Abkleben, 2) Risse ausbessern, \n   3) Spachteln Q2, 4) Grundierung, 5) 2Ã— Wandanstrich + Decke\"\n\n4. Besonderheiten\n   \"Altbau erkannt (Baujahr ca. 1960) â†’ 10% Zuschlag kalkuliert. \n   RaumhÃ¶he geschÃ¤tzt: 2.5m (Standard)\"\n\n5. ZeitschÃ¤tzung (optional aber professionell)\n   \"GeschÃ¤tzter Zeitaufwand: 3-4 Arbeitstage (1 Maler)\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš ï¸ KRITISCHE ANFORDERUNGEN\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Gib AUSSCHLIESSLICH valides JSON zurÃ¼ck\n2. KEINE Markdown-Formatierung (```json verboten!)\n3. KEINE ErklÃ¤rungen vor/nach dem JSON\n4. NUR das JSON-Objekt\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“¤ EXAKTES AUSGABEFORMAT\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n{\n  \"positionen\": [\n    {\n      \"titel\": \"MÃ¶bel abdecken/schÃ¼tzen\",\n      \"menge\": 25,\n      \"einheit\": \"mÂ²\",\n      \"einzelpreis\": 8.50,\n      \"summe\": 212.50\n    },\n    {\n      \"titel\": \"Abkleben Fenster, TÃ¼ren, Steckdosen\",\n      \"menge\": 66,\n      \"einheit\": \"mÂ²\",\n      \"einzelpreis\": 4.50,\n      \"summe\": 297.00\n    },\n    {\n      \"titel\": \"Risse ausbessern\",\n      \"menge\": 8,\n      \"einheit\": \"lfm\",\n      \"einzelpreis\": 12.00,\n      \"summe\": 96.00\n    },\n    {\n      \"titel\": \"Spachteln Q2 (Standard-GlÃ¤tte)\",\n      \"menge\": 66,\n      \"einheit\": \"mÂ²\",\n      \"einzelpreis\": 18.00,\n      \"summe\": 1188.00\n    },\n    {\n      \"titel\": \"Grundierung WÃ¤nde\",\n      \"menge\": 66,\n      \"einheit\": \"mÂ²\",\n      \"einzelpreis\": 3.80,\n      \"summe\": 250.80\n    },\n    {\n      \"titel\": \"Wandanstrich weiÃŸ 2-fach\",\n      \"menge\": 66,\n      \"einheit\": \"mÂ²\",\n      \"einzelpreis\": 12.50,\n      \"summe\": 825.00\n    },\n    {\n      \"titel\": \"Deckenanstrich weiÃŸ 2-fach\",\n      \"menge\": 25,\n      \"einheit\": \"mÂ²\",\n      \"einzelpreis\": 14.50,\n      \"summe\": 362.50\n    },\n    {\n      \"titel\": \"Anfahrt Hamburg-City\",\n      \"menge\": 1,\n      \"einheit\": \"pauschal\",\n      \"einzelpreis\": 59.00,\n      \"summe\": 59.00\n    },\n    {\n      \"titel\": \"Entsorgung Altmaterial\",\n      \"menge\": 1,\n      \"einheit\": \"pauschal\",\n      \"einzelpreis\": 45.00,\n      \"summe\": 45.00\n    }\n  ],\n  \"gesamt_netto\": 3335.80,\n  \"ki_analyse_notiz\": \"Kalkulation fÃ¼r Wohnzimmer 25mÂ² BodenflÃ¤che. WandflÃ¤che berechnet: 4 WÃ¤nde Ã— 2.5m HÃ¶he Ã— ca. 7.2m Umfang = 72mÂ², abzÃ¼glich 2 Fenster + 1 TÃ¼r (6mÂ²) = 66mÂ² netto. DeckenflÃ¤che: 25mÂ². Zustand: Mittel (Beschreibung erwÃ¤hnt kleine Risse). Empfohlener Ablauf: 1) MÃ¶bel schÃ¼tzen, 2) Abkleben, 3) Risse ausbessern (ca. 8 Laufmeter geschÃ¤tzt), 4) Spachteln Q2, 5) Grundierung, 6) 2-fach Wandanstrich + Decke. Altbau erkannt (Standard-Zuschlag bereits in StundensÃ¤tzen berÃ¼cksichtigt). GeschÃ¤tzter Zeitaufwand: 2-3 Arbeitstage.\"\n}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ’¡ PRAXIS-BEISPIELE ZUR ORIENTIERUNG\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nBEISPIEL 1: Einfacher Auftrag\nEingabe: \"Schlafzimmer 15mÂ², guter Zustand, nur weiÃŸ streichen\"\nâ†’ Berechnung: 52mÂ² Wand - 15% = 44mÂ² | Decke 15mÂ²\nâ†’ Positionen: Abkleben + Grundierung + Anstrich + Decke + Anfahrt\nâ†’ Gesamt: ~1.200â‚¬ netto\n\nBEISPIEL 2: Mittlerer Auftrag\nEingabe: \"Wohnzimmer 25mÂ², Risse in WÃ¤nden, Raufaser entfernen\"\nâ†’ Berechnung: 72mÂ² Wand - 15% = 61mÂ² | Decke 25mÂ²\nâ†’ Positionen: MÃ¶bel + Abkleben + Tapete entfernen + Risse + Spachteln Q2 + Grundierung + Anstrich + Decke + Anfahrt + Entsorgung\nâ†’ Gesamt: ~3.500â‚¬ netto\n\nBEISPIEL 3: Komplexer Auftrag\nEingabe: \"3-Zimmer-Wohnung 75mÂ², Altbau, Ã¼berall streichen\"\nâ†’ Berechnung: 3 RÃ¤ume einzeln + Flur\n  * Wohnzimmer 25mÂ² â†’ 61mÂ² Wand + 25mÂ² Decke\n  * Schlafzimmer 20mÂ² â†’ 53mÂ² Wand + 20mÂ² Decke\n  * Arbeitszimmer 15mÂ² â†’ 40mÂ² Wand + 15mÂ² Decke\n  * Flur 15mÂ² â†’ 45mÂ² Wand + 15mÂ² Decke\n  â†’ Gesamt: 199mÂ² Wand + 75mÂ² Decke\nâ†’ Positionen: VollstÃ¤ndig mit Altbau-Zuschlag\nâ†’ Gesamt: ~9.800â‚¬ netto\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸš€ JETZT BIST DU DRAN - KALKULIERE PROFESSIONELL!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
          ]
        },
        "builtInTools": {},
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        576,
        640
      ],
      "id": "8590398c-efdf-4a58-b7c6-f11f93f472a6",
      "name": "ğŸ’¬ Text Kalkulation",
      "credentials": {
        "googlePalmApi": {
          "id": "4IKHqkxZV1IUnL4q",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.routeType }}",
                    "rightValue": "text_only",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "00ace5cd-7730-4f43-ab7d-7acbd5e09136"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ğŸ“ Nur Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.routeType }}",
                    "rightValue": "image_analysis",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3afc70bd-9572-4f05-83cb-015a9728d8a5"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ğŸ–¼ï¸ Bild Analyse"
            }
          ]
        },
        "options": {}
      },
      "id": "7ec78c80-ead8-4fd6-8483-2c7272b83cf3",
      "name": "ğŸ”€ Routing Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        160,
        768
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// SCHRITT 1: Eingabedaten Validierung & Prep\n// ============================================\n\nconst body = $input.item.json.body || {};\nconst binary = $input.item.binary || {};\n\n// Extrahiere Textdaten\nconst customerName = body.customerName || 'Unbekannter Kunde';\nconst address = body.address || '';\nconst notes = body.notes || '';\n\n// Verarbeite hochgeladene Medien\nlet mediaFiles = [];\nlet imageCount = 0;\nlet videoCount = 0;\n\nfor (const [key, file] of Object.entries(binary)) {\n  const mimeType = file.mimeType || '';\n  \n  if (mimeType.startsWith('image/')) {\n    mediaFiles.push({\n      type: 'image',\n      key: key,\n      fileName: file.fileName || `image_${imageCount}`,\n      mimeType: mimeType,\n      size: file.fileSize || 0\n    });\n    imageCount++;\n  } else if (mimeType.startsWith('video/')) {\n    mediaFiles.push({\n      type: 'video',\n      key: key,\n      fileName: file.fileName || `video_${videoCount}`,\n      mimeType: mimeType,\n      size: file.fileSize || 0\n    });\n    videoCount++;\n  }\n}\n\n// Bestimme Analyse-Route\nlet routeType = 'text_only';\nif (imageCount > 0 && videoCount === 0) {\n  routeType = 'image_analysis';\n} else if (videoCount > 0 && imageCount === 0) {\n  routeType = 'video_analysis';\n} else if (imageCount > 0 && videoCount > 0) {\n  routeType = 'mixed_media';\n}\n\nreturn {\n  json: {\n    customerName,\n    address,\n    notes,\n    mediaFiles,\n    imageCount,\n    videoCount,\n    totalMediaCount: mediaFiles.length,\n    routeType,\n    timestamp: new Date().toISOString()\n  },\n  binary: binary\n};"
      },
      "id": "1413b8f3-32e3-423b-84e7-f181af34d0b7",
      "name": "ğŸ” Daten Vorbereitung",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        784
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "maler-angebot",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*",
          "rawBody": false
        }
      },
      "id": "3b0e4673-00da-4bbe-a8e9-707121e92cbb",
      "name": "ğŸ“¥ Webhook Empfang",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -400,
        832
      ],
      "webhookId": "paintquote-ai-webhook"
    }
  ],
  "connections": {
    "âœ¨ JSON Bereinigung": {
      "main": [
        [
          {
            "node": "âœ… Antwort senden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ–¼ï¸ Bild Analyse": {
      "main": [
        [
          {
            "node": "âœ¨ JSON Bereinigung",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¬ Text Kalkulation": {
      "main": [
        [
          {
            "node": "âœ¨ JSON Bereinigung",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Routing Switch": {
      "main": [
        [
          {
            "node": "ğŸ’¬ Text Kalkulation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ–¼ï¸ Bild Analyse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Daten Vorbereitung": {
      "main": [
        [
          {
            "node": "ğŸ”€ Routing Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Webhook Empfang": {
      "main": [
        [
          {
            "node": "ğŸ” Daten Vorbereitung",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "85466264b1740098c85fda7229dbc4dbd2e163a613b315dae71b7c828e6d126b"
  }
}